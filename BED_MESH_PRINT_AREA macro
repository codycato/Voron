[gcode_macro BED_MESH_PRINT_AREA]
; gcode parameters
variable_parameter_AREA_START_X : 40
variable_parameter_AREA_START_Y : 40
variable_parameter_AREA_END_X : 320
variable_parameter_AREA_END_Y : 320
; the "safe" area that the probe can reach, use value in config->[bed_mesh]
variable_mesh_min_x :40
variable_mesh_min_y :40
variable_mesh_max_x :320
variable_mesh_max_y :320
; the clearance between print area and probe area 
variable_mesh_area_offset : 5
variable_probe_samples : 2
variable_mesh_size : 6
gcode:
    M118 ({params.AREA_START_X|float},{params.AREA_END_X|float})
    {% if (params.AREA_START_X|float < params.AREA_END_X|float) and (params.AREA_START_Y|float < params.AREA_END_Y|float) %}
        {% if params.AREA_START_X|default(0)|float - mesh_area_offset >=  mesh_min_x %}
            {% set mesh_min_x = params.AREA_START_X|default(0)|float - mesh_area_offset %}
        {% endif %}
        {% if params.AREA_START_Y|default(0)|float - mesh_area_offset >=  mesh_min_y %}
            {% set mesh_min_y = params.AREA_START_Y|default(0)|float - mesh_area_offset %}
        {% endif %}
        {% if params.AREA_END_X|default(0)|float + mesh_area_offset <=  mesh_max_x %}
            {% set mesh_max_x = params.AREA_END_X|default(0)|float + mesh_area_offset %}
        {% endif %}
        {% if params.AREA_END_Y|default(0)|float + mesh_area_offset <=  mesh_max_y %}
            {% set mesh_max_y = params.AREA_END_Y|default(0)|float + mesh_area_offset %}
        {% endif %}
        PRINT MSG="Set custom mesh area to ({mesh_min_x},{mesh_min_y}),({mesh_max_x},{mesh_max_y})"
        {% if (params.AREA_END_X|float - params.AREA_START_X|float)*(params.AREA_END_Y|float - params.AREA_START_Y|float) < 20250.0 %}
            {% set mesh_size = 4 %}
        {% elif (params.AREA_END_X|float - params.AREA_START_X|float)*(params.AREA_END_Y|float - params.AREA_START_Y|float) < 13500.0 %}
            {% set mesh_size = 3 %}
        {% endif %}
        PRINT MSG="Set custom mesh matrix to {mesh_size}x{mesh_size}"
        BED_MESH_CALIBRATE mesh_min={mesh_min_x|float},{mesh_min_y|float} mesh_max={mesh_max_x|float},{mesh_max_y|float} probe_count={mesh_size|int},{mesh_size|int} samples={probe_samples|int}
    {% else %}
        PRINT MSG="Invalid custom mesh parameters, probe using default setting"
        BED_MESH_CALIBRATE
    {% endif %}
